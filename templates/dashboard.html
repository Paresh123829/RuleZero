<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Dashboard - Civic Eye</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .dashboard-card { border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .civic-points { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .status-badge { font-size: 0.8em; }
        .notification-item { border-left: 4px solid #007bff; padding-left: 15px; margin-bottom: 10px; }
        .map-container { height: 300px; background: #f8f9fa; border-radius: 10px; }
    </style>
</head>
<body class="bg-light">
    <!-- Header -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/home"><i class="fas fa-eye"></i> Civic Eye</a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text me-3">Welcome, {{ user.username }} ðŸ‘‹</span>
                <a href="/auth/logout" class="btn btn-outline-light btn-sm">Logout</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Top Stats Row -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card dashboard-card civic-points">
                    <div class="card-body text-center">
                        <h3><i class="fas fa-trophy"></i> {{ civic_points }}</h3>
                        <p class="mb-0">Civic Points</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card dashboard-card">
                    <div class="card-body text-center">
                        <h3 class="text-primary">{{ reports|length }}</h3>
                        <p class="mb-0">Total Complaints</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card dashboard-card">
                    <div class="card-body text-center">
                        <h3 class="text-success">{{ reports|selectattr("status", "equalto", "resolved")|list|length }}</h3>
                        <p class="mb-0">Resolved</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card dashboard-card">
                    <div class="card-body text-center">
                        <a href="/report" class="btn btn-success btn-lg w-100">
                            <i class="fas fa-plus"></i> New Complaint
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- My Complaints Table -->
            <div class="col-lg-8">
                <div class="card dashboard-card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="fas fa-list"></i> My Complaints</h5>
                        <div>
                            <select class="form-select form-select-sm" id="statusFilter">
                                <option value="">All Status</option>
                                <option value="submitted">Pending</option>
                                <option value="in_progress">In Progress</option>
                                <option value="resolved">Resolved</option>
                            </select>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <input type="text" class="form-control" id="searchComplaint" placeholder="Search by Complaint ID...">
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Issue Type</th>
                                        <th>Date</th>
                                        <th>Status</th>
                                        <th>Location</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="complaintsTable">
                                    {% for report in reports %}
                                    <tr data-status="{{ report.status }}" class="{% if report.status == 'resolved' %}table-success{% elif report.status == 'in_progress' %}table-warning{% endif %}">
                                        <td>
                                            <code>{{ report.report_id }}</code>
                                        </td>
                                        <td>{{ report.issue_type|title }}</td>
                                        <td>{{ report.created_at[:10] }}</td>
                                        <td>
                                            {% if report.status == 'resolved' %}
                                                <span class="badge bg-success status-badge">
                                                    <i class="fas fa-check-circle"></i> Resolved
                                                </span>
                                            {% elif report.status == 'in_progress' %}
                                                <span class="badge bg-warning status-badge">
                                                    <i class="fas fa-clock"></i> In Progress
                                                </span>
                                            {% else %}
                                                <span class="badge bg-secondary status-badge">
                                                    <i class="fas fa-hourglass-half"></i> Pending
                                                </span>
                                            {% endif %}
                                        </td>
                                        <td>{{ ((report.location or {}).get('address') or 'Unknown')[:20] }}...</td>
                                        <td>
                                            <a href="/track?id={{ report.report_id }}" class="btn btn-sm btn-outline-primary">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        <div class="mt-3">
                            <button class="btn btn-outline-secondary btn-sm" onclick="downloadReport()">
                                <i class="fas fa-download"></i> Download Report (PDF)
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Complaint Map View -->
                <div class="card dashboard-card mt-4">
                    <div class="card-header">
                        <h5><i class="fas fa-map-marker-alt"></i> My Complaints Map</h5>
                    </div>
                    <div class="card-body">
                        <div id="userMap" style="height: 300px; border-radius: 10px;"></div>
                        <div class="mt-2 text-center">
                            <small class="text-muted">{{ reports|length }} complaints plotted</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="col-lg-4">
                <!-- Notifications -->
                <div class="card dashboard-card mb-4">
                    <div class="card-header">
                        <h5><i class="fas fa-bell"></i> Recent Updates</h5>
                    </div>
                    <div class="card-body">
                        {% if notifications %}
                            {% for notification in notifications %}
                            <div class="notification-item">
                                <small class="text-muted">{{ notification.date[:10] }}</small>
                                <p class="mb-1">{{ notification.message }}</p>
                            </div>
                            {% endfor %}
                        {% else %}
                            <p class="text-muted text-center">No recent updates</p>
                        {% endif %}
                        
                        <!-- Show solved complaints notification -->
                        {% set solved_count = reports|selectattr("status", "equalto", "resolved")|list|length %}
                        {% if solved_count > 0 %}
                        <div class="alert alert-success mt-3" role="alert">
                            <i class="fas fa-check-circle"></i>
                            <strong>Great news!</strong> You have {{ solved_count }} resolved complaint{{ 's' if solved_count != 1 else '' }}. 
                            {% if solved_count > 0 %}
                                <small class="d-block mt-1">Keep up the great work contributing to your community!</small>
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Leaderboard -->
                <div class="card dashboard-card">
                    <div class="card-header">
                        <h5><i class="fas fa-trophy"></i> Top Reporters</h5>
                    </div>
                    <div class="card-body">
                        {% for user in leaderboard[:5] %}
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div>
                                <span class="badge bg-primary me-2">{{ loop.index }}</span>
                                <strong>{{ user._id }}</strong>
                            </div>
                            <span class="text-muted">{{ user.points }} pts</span>
                        </div>
                        {% endfor %}
                        
                        {% if not leaderboard %}
                        <p class="text-muted text-center">No data available</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    
    <script>
        // Initialize map
        const map = L.map('userMap').setView([26.2183, 78.1828], 12); // Gwalior coordinates
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);
        
        // Custom colored marker icons
        const redIcon = new L.Icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        });
        const greenIcon = new L.Icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        });
        const blueIcon = new L.Icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        });

        // Add markers for user complaints
        const reports = {{ reports|tojson }};
        reports.forEach(report => {
            if (report.location && report.location.latitude && report.location.longitude) {
                const lat = parseFloat(report.location.latitude);
                const lng = parseFloat(report.location.longitude);
                
                if (!isNaN(lat) && !isNaN(lng)) {
                    // Choose icon based on issue type
                    const type = (report.issue_type || '').toLowerCase();
                    let icon = blueIcon; // default
                    if (type === 'pothole') {
                        icon = redIcon;
                    } else if (type === 'garbage') {
                        icon = greenIcon;
                    }

                    const marker = L.marker([lat, lng], { icon }).addTo(map);
                    
                    const statusColor = report.status === 'resolved' ? 'green' : 
                                      report.status === 'in_progress' ? 'orange' : 'red';
                    
                    marker.bindPopup(`
                        <div>
                            <strong>${report.issue_type}</strong><br>
                            <span style="color: ${statusColor}">${report.status}</span><br>
                            <small>${report.created_at.substring(0, 10)}</small>
                        </div>
                    `);
                }
            }
        });
        
        // If no reports, show default view
        if (reports.length === 0) {
            map.setView([26.2183, 78.1828], 12);
        }

        // Filter complaints by status
        document.getElementById('statusFilter').addEventListener('change', function() {
            const filter = this.value;
            const rows = document.querySelectorAll('#complaintsTable tr');
            
            rows.forEach(row => {
                if (!filter || row.dataset.status === filter) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        });

        // Search complaints by ID
        document.getElementById('searchComplaint').addEventListener('input', function() {
            const search = this.value.toLowerCase();
            const rows = document.querySelectorAll('#complaintsTable tr');
            
            rows.forEach(row => {
                const id = row.cells[0].textContent.toLowerCase();
                if (id.includes(search)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        });

        // Download report function
        function downloadReport() {
            alert('PDF download feature coming soon!');
        }
    </script>
</body>
</html>
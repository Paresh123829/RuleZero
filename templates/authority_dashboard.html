<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Authority Dashboard - Civic Eye</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .complaint-card { border: 1px solid #ddd; margin: 10px 0; padding: 15px; border-radius: 8px; }
        .complaint-header { display: flex; justify-content: between; align-items: center; margin-bottom: 10px; }
        .status-badge { padding: 5px 10px; border-radius: 15px; color: white; font-size: 12px; }
        .status-submitted { background: #007bff; }
        .status-in_progress { background: #ffc107; color: #000; }
        .status-resolved { background: #28a745; }
        .complaint-image { max-width: 200px; height: auto; border-radius: 5px; margin: 10px 0; }
        .action-buttons { margin-top: 15px; }
        .btn-resolve { background: #28a745; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; }
        .btn-progress { background: #ffc107; color: #000; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; }
    </style>
</head>
<body>
    <header class="main-header">
        <div class="header-content">
            <h1><i class="fas fa-eye"></i> <a href="{{ url_for('home') }}">Civic Eye - Authority Dashboard</a></h1>
            <nav class="main-nav">
                <ul>
                    <li><a href="{{ url_for('home') }}"><i class="fas fa-home"></i> Home</a></li>
                    <li><a href="{{ url_for('auth_logout') }}"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <main class="main-content">
        {% with messages = get_flashed_messages() %}
            {% if messages %}
                <div class="alert-container">
                    {% for message in messages %}
                        <div class="alert alert-info">{{ message }}</div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

        <div class="container">
            <h2><i class="fas fa-tasks"></i> Real-time Complaint Management</h2>
            
            <div class="stats-row" style="display: flex; gap: 20px; margin: 20px 0;">
                <div class="stat-card" style="flex: 1; padding: 15px; background: #f8f9fa; border-radius: 8px; text-align: center;">
                    <h3>{{ total_complaints }}</h3>
                    <p>Total Complaints</p>
                </div>
                <div class="stat-card" style="flex: 1; padding: 15px; background: #fff3cd; border-radius: 8px; text-align: center;">
                    <h3>{{ pending_complaints }}</h3>
                    <p>Pending</p>
                </div>
                <div class="stat-card" style="flex: 1; padding: 15px; background: #d1ecf1; border-radius: 8px; text-align: center;">
                    <h3>{{ in_progress_complaints }}</h3>
                    <p>In Progress</p>
                </div>
                <div class="stat-card" style="flex: 1; padding: 15px; background: #d4edda; border-radius: 8px; text-align: center;">
                    <h3>{{ resolved_complaints }}</h3>
                    <p>Resolved</p>
                </div>
            </div>

            <div class="complaints-list">
                {% for report in reports %}
                <div class="complaint-card">
                    <div class="complaint-header">
                        <div>
                            <h4><i class="fas fa-hashtag"></i> {{ report.report_id }}</h4>
                            <small><i class="fas fa-calendar"></i> {{ report.created_at }}</small>
                        </div>
                        <span class="status-badge status-{{ report.status }}">
                            {{ report.status.replace('_', ' ').title() }}
                        </span>
                    </div>
                    
                    <div class="complaint-details">
                        <p><strong><i class="fas fa-tags"></i> Issue Type:</strong> {{ report.issue_type.title() }}</p>
                        <p><strong><i class="fas fa-edit"></i> Description:</strong> {{ report.text or 'No description' }}</p>
                        
                        {% if report.location %}
                        <p><strong><i class="fas fa-map-marker-alt"></i> Location:</strong> 
                           Lat: {{ report.location.latitude }}, Lng: {{ report.location.longitude }}</p>
                        {% endif %}
                        
                        {% if report.image_path %}
                        <div>
                            <strong><i class="fas fa-camera"></i> Image:</strong><br>
                            <img src="{{ url_for('static', filename='../uploads/' + report.image_path.split('/')[-1]) }}" 
                                 alt="Complaint Image" class="complaint-image">
                        </div>
                        {% endif %}
                        
                        {% if report.voice_text %}
                        <p><strong><i class="fas fa-microphone"></i> Voice Text:</strong> {{ report.voice_text }}</p>
                        {% endif %}
                        
                        {% if report.fake %}
                        <p style="color: red;"><strong><i class="fas fa-exclamation-triangle"></i> Warning:</strong> 
                           Flagged as potentially fake (Score: {{ "%.2f"|format(report.fake_score) }})</p>
                        {% endif %}
                    </div>
                    
                    <div class="action-buttons">
                        {% if report.status == 'submitted' %}
                        <button class="btn-progress" onclick="updateStatus('{{ report.report_id }}', 'in_progress')">
                            <i class="fas fa-play"></i> Mark In Progress
                        </button>
                        {% endif %}
                        
                        {% if report.status in ['submitted', 'in_progress'] %}
                        <button class="btn-resolve" onclick="updateStatus('{{ report.report_id }}', 'resolved')">
                            <i class="fas fa-check"></i> Mark as Resolved
                        </button>
                        {% endif %}
                        
                        {% if report.status == 'resolved' %}
                        <span style="color: green; font-weight: bold;">
                            <i class="fas fa-check-circle"></i> Complaint Resolved âœ…
                        </span>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </main>

    <script>
        function updateStatus(reportId, newStatus) {
            if (confirm(`Are you sure you want to mark this complaint as ${newStatus.replace('_', ' ')}?`)) {
                fetch('/api/update_status', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        report_id: reportId,
                        status: newStatus
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload(); // Refresh page to show updated status
                    } else {
                        alert('Failed to update status');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error updating status');
                });
            }
        }
        
        // Auto-refresh every 30 seconds for real-time updates
        setInterval(() => {
            location.reload();
        }, 30000);
    </script>
</body>
</html>